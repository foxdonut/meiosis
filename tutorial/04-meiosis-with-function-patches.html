<!DOCTYPE html>
<html>
  <head>
    <title>Meiosis Tutorial</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="normalize.css">
    <link rel="stylesheet" href="skeleton.css">
    <link rel="stylesheet" href="prism.css">
    <link rel="stylesheet" href="style.css">
  </head>
  <body class="container">
    <script src="prism.js" type="text/javascript"></script>
    <script src="https://flems.io/flems.html" type="text/javascript" charset="utf-8"></script>
    <h1><a href="https://meiosis.js.org">Meiosis</a> Tutorial</h1><p><a href="03-streams.html">&lt; Previous</a> |
<a href="05-meiosis-with-patchinko.html">Next &gt;</a> |
<a href="toc.html">Table of Contents</a></p>
<h2>04 - Meiosis with Function Patches</h2><p>In the previous lesson, <a href="03-streams.html">03 - Streams</a>, we started setting up the
Meiosis pattern:</p>
<ul>
<li>an <code>update</code> stream of <strong>patches</strong></li>
<li>a <code>states</code> stream of states, obtained with <code>scan</code> on the <code>update</code> stream and applying
an <strong>accumulator</strong></li>
<li>an <code>actions</code> object created by passing <code>update</code> and having functions that call <code>update</code>
to trigger state changes.</li>
</ul>
<p>Our state had the following shape:</p>
<pre><code class="language-js">{
  value: 0
}</code></pre>
<p>Our patches were numbers such as <code>1</code> and <code>-1</code>, and our accumulator applied the patches to the
state by adding the number to <code>state.value</code>.</p>
<p>We are going to change our patches and accumulator function to be general-purpose, so that the
shape of our state can be much more flexible, and our actions can issue patches to make all sorts
of changes to the state.</p>
<p><a name="temperature_example"></a></p>
<h3><a href="#temperature_example">A Temperature Example</a></h3><p>Let&#39;s build a temperature example with the following initial state:</p>
<pre><code class="language-js">{
  temperature: {
    value: 22,
    units: &quot;C&quot;
  }
}</code></pre>
<p>We can increase and decrease the value, as well as change the units betwen <code>C</code> (Celsius) and
<code>F</code> (Farenheit), converting the value in the process.</p>
<p>We need to:</p>
<ul>
<li>Decide the shape of our patches</li>
<li>Write an accumulator function that will use those patches to produce the updated state.</li>
</ul>
<p>In this section, we will use one approach using <strong>function patches</strong>. In the next section, we
will look at another approach - my personal favourite - using a small utility called Patchinko.</p>
<p><a name="using_function_patches"></a></p>
<h3><a href="#using_function_patches">Using Function Patches</a></h3><p>Instead of using plain numbers as patches, which are limited to incrementing a counter, we can
use <strong>functions</strong>. Indeed, we can pass functions onto the <code>update</code> stream and use them in the
accumulator to update the state.</p>
<p>These functions receive the current state as a parameter, and return the updated state.
For example, to increment the temperature value:</p>
<pre><code class="language-js">increment: function(amount) {
  update(function(state) {
    state.temperature.value += amount;
    return state;
  });
}</code></pre>
<p>Now we need to use these function patches in the accumulator function. Remember that the
accumulator gets the current state and the incoming patch as parameters, and must return the
updated state. Since the incoming patches are functions, we just need to call them:</p>
<pre><code class="language-js">var states = flyd.scan(function(state, patch) {
  return patch(state);
}, temperature.Initial(), update);</code></pre>
<p>Using the ES6 arrow function syntax, this would be:</p>
<pre><code class="language-js">var states = flyd.scan((state, patch) =&gt; patch(state),
  temperature.Initial(), update);</code></pre>
<p>Either way, it&#39;s a simple way to create the stream of states.</p>
<p>Putting it all together, we have:</p>
<div id="flems1" class="flemscode" style="height:800px"></div>
  <script>
    window.Flems(flems1, {
      files: [{name: "04-meiosis-with-function-patches-01.js", content: "/*global flyd*/\nvar convert = function(value, to) {\n  return Math.round(\n    to === \"C\" ? ((value - 32) / 9) * 5 : (value * 9) / 5 + 32\n  );\n};\n\nvar temperature = {\n  Initial: function() {\n    return {\n      temperature: {\n        value: 22,\n        units: \"C\"\n      }\n    };\n  },\n  Actions: function(update) {\n    return {\n      increment: function(amount) {\n        update(function(state) {\n          state.temperature.value += amount;\n          return state;\n        });\n      },\n      changeUnits: function() {\n        update(function(state) {\n          var value = state.temperature.value;\n          var newUnits =\n            state.temperature.units === \"C\" ? \"F\" : \"C\";\n          var newValue = convert(value, newUnits);\n          state.temperature.value = newValue;\n          state.temperature.units = newUnits;\n          return state;\n        });\n      }\n    };\n  }\n};\n\nvar update = flyd.stream();\nvar states = flyd.scan(\n  function(state, patch) {\n    return patch(state);\n  },\n  temperature.Initial(),\n  update\n);\n\nvar actions = temperature.Actions(update);\nstates.map(function(state) {\n  document.write(\n    \"<pre>\" + JSON.stringify(state, null, 2) + \"</pre>\"\n  );\n});\n"}],
      links: [{name: "flyd", type: "js", url: "https://unpkg.com/flyd@0.2.8/flyd.js"}],
      middle: 75
    })
  </script>


<p><a name="exercises"></a></p>
<h3><a href="#exercises">Exercises</a></h3><p>Try it out: notice that the initial state appears in the output on the right. Within the console,
type and then press Enter:</p>
<p><code>actions.increment(2)</code></p>
<p><code>actions.changeUnits()</code></p>
<p>In the output on the right, you&#39;ll see the updated states.</p>
<p>In the next section, <a href="05-meiosis-with-patchinko.html">05 - Meiosis with Patchinko</a>, we will look
at an alternative to function patches.</p>
<p><a href="03-streams.html">&lt; Previous</a> |
<a href="05-meiosis-with-patchinko.html">Next &gt;</a> |
<a href="toc.html">Table of Contents</a></p>
<hr>
<p><a href="https://meiosis.js.org">Meiosis</a> is developed by <a href="http://twitter.com/foxdonut00">@foxdonut00</a> / <a href="https://github.com/foxdonut">foxdonut</a> and is released under the MIT license.</p>
  </body>
</html>